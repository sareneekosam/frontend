<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TVA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 30px auto;
            padding: 0 15px;
        }
        .admin-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 0;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .action-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            height: 100%;
        }
        .action-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            text-decoration: none;
            color: inherit;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .action-icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 15px;
        }
        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        .activity-item:hover {
            background-color: #f8f9fa;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .badge {
            font-size: 0.75em;
        }
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }
        .system-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>TVA- Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="admin.html"><i class="fas fa-home me-1"></i> Dashboard</a>
                <a class="nav-link" href="admin-clients.html"><i class="fas fa-users me-1"></i> Clients</a>
                <a class="nav-link" href="admin-notifications.html">
                    <i class="fas fa-bell me-1"></i> Notifications
                    <span class="badge bg-danger ms-1" id="notificationBadge" style="display: none;">0</span>
                </a>
                <a class="nav-link" href="admin-question-requests.html"><i class="fas fa-comments me-1"></i> Question Requests</a>
                <a class="nav-link" href="admin-subscriptions.html"><i class="fas fa-crown me-1"></i> Subscriptions</a>
                <a class="nav-link" href="admin-logs.html"><i class="fas fa-history me-1"></i> System Logs</a>
                <a class="nav-link" href="#" onclick="authService.logout()"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Header Section -->
        <div class="admin-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h1>
                    <p class="text-muted mb-0">Welcome to TVA Admin Panel - Monitor system performance and manage operations</p>
                </div>
                <div class="text-end">
                    <div id="currentTime" class="text-muted small"></div>
                    <div class="text-success small">
                        <i class="fas fa-circle me-1"></i>System Online
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalClients">0</div>
                <div class="stat-label">Total Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeSubscriptions">0</div>
                <div class="stat-label">Active Subscriptions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingRequests">0</div>
                <div class="stat-label">Pending Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">0</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadNotifications">0</div>
                <div class="stat-label">Unread Notifications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">₹0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="admin-section">
            <h4><i class="fas fa-bolt me-2"></i>Quick Actions</h4>
            <div class="quick-actions">
                <a href="admin-clients.html" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h6>Manage Clients</h6>
                    <p class="text-muted small mb-0">View and manage all client accounts</p>
                </a>
                
                <a href="admin-notifications.html" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <h6>Notifications</h6>
                    <p class="text-muted small mb-0">View system notifications</p>
                </a>
                <a href="admin-question-requests.html" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h6>Question Requests</h6>
                    <p class="text-muted small mb-0">Process client requests</p>
                </a>
                <a href="admin-subscriptions.html" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h6>Subscriptions</h6>
                    <p class="text-muted small mb-0">Manage client subscriptions</p>
                </a>
                <a href="admin-logs.html" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <h6>System Logs</h6>
                    <p class="text-muted small mb-0">View audit and system logs</p>
                </a>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="admin-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-history me-2"></i>Recent Activity</h4>
                <a href="admin-logs.html" class="btn btn-outline-primary btn-sm">View All Logs</a>
            </div>
            <div class="recent-activity" id="recentActivity">
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h5>No Recent Activity</h5>
                    <p>System activity will appear here</p>
                </div>
            </div>
        </div>

        <!-- System Status Section -->
        <div class="admin-section">
            <h4><i class="fas fa-server me-2"></i>System Status</h4>
            <div class="system-status-grid">
                <div class="status-card">
                    <i class="fas fa-database fa-2x text-primary mb-3"></i>
                    <h6>Database</h6>
                    <span class="badge bg-success">Connected</span>
                    <p class="text-muted small mt-2 mb-0">MongoDB Connection</p>
                </div>
                <div class="status-card">
                    <i class="fas fa-envelope fa-2x text-info mb-3"></i>
                    <h6>Email Service</h6>
                    <span class="badge bg-success">Active</span>
                    <p class="text-muted small mt-2 mb-0">SMTP Server</p>
                </div>
                <div class="status-card">
                    <i class="fas fa-credit-card fa-2x text-warning mb-3"></i>
                    <h6>Payment Gateway</h6>
                    <span class="badge bg-success">Connected</span>
                    <p class="text-muted small mt-2 mb-0">Razorpay Integration</p>
                </div>
                <div class="status-card">
                    <i class="fas fa-robot fa-2x text-success mb-3"></i>
                    <h6>AI Model</h6>
                    <span class="badge bg-success">Loaded</span>
                    <p class="text-muted small mt-2 mb-0">Sentence Transformers</p>
                </div>
                <div class="status-card">
                    <i class="fas fa-shield-alt fa-2x text-danger mb-3"></i>
                    <h6>Security</h6>
                    <span class="badge bg-success">Active</span>
                    <p class="text-muted small mt-2 mb-0">JWT Authentication</p>
                </div>
                <div class="status-card">
                    <i class="fas fa-network-wired fa-2x text-secondary mb-3"></i>
                    <h6>API Server</h6>
                    <span class="badge bg-success">Running</span>
                    <p class="text-muted small mt-2 mb-0">FastAPI Backend</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../scripts/auth.js"></script>
    <script>
        let notificationCheckInterval = null;

        // Load dashboard data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is admin
            if (authService.getUserType() !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'dashboard.html';
                return;
            }
            
            await loadDashboardData();
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000); // Update time every minute
            
            // Start notification polling
            startNotificationPolling();
        });

        // Start polling for notifications every 15 seconds
        function startNotificationPolling() {
            checkUnreadNotifications();
            notificationCheckInterval = setInterval(checkUnreadNotifications, 15000); // 15 seconds
        }

        // Check for unread notifications
        async function checkUnreadNotifications() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/unread-count`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const unreadCount = data.unread_count || 0;
                    const notificationBadge = document.getElementById('notificationBadge');
                    
                    if (unreadCount > 0) {
                        notificationBadge.textContent = unreadCount;
                        notificationBadge.style.display = 'inline';
                        // Add pulse animation for new notifications
                        notificationBadge.classList.add('pulse');
                    } else {
                        notificationBadge.style.display = 'none';
                        notificationBadge.classList.remove('pulse');
                    }
                }
            } catch (error) {
                console.error('Error checking notifications:', error);
            }
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadClientsCount(),
                    loadSubscriptionsData(),
                    loadQuestionsData(),
                    loadNotificationsCount(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadClientsCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/clients`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    document.getElementById('totalClients').textContent = clients.length;
                }
            } catch (error) {
                console.error('Error loading clients count:', error);
            }
        }

        async function loadSubscriptionsData() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/subscriptions`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const subscriptions = await response.json();
                    const activeSubscriptions = subscriptions.filter(sub => {
                        const endDate = new Date(sub.end_date);
                        return endDate > new Date();
                    });
                    
                    document.getElementById('activeSubscriptions').textContent = activeSubscriptions.length;
                    
                    // Calculate total revenue
                    const totalRevenue = subscriptions.reduce((sum, sub) => sum + (sub.amount || 0), 0) / 100;
                    document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
                }
            } catch (error) {
                console.error('Error loading subscriptions data:', error);
            }
        }

        async function loadQuestionsData() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/questions`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const questions = await response.json();
                    document.getElementById('totalQuestions').textContent = questions.length;
                }
            } catch (error) {
                console.error('Error loading questions data:', error);
            }
        }

        async function loadNotificationsCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/unread-count`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('unreadNotifications').textContent = data.unread_count;
                }
            } catch (error) {
                console.error('Error loading notifications count:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/logs?limit=10`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const logs = await response.json();
                    displayRecentActivity(logs);
                    
                    // Update pending requests count from logs
                    const pendingRequests = logs.filter(log => 
                        log.action.includes('question_request') && 
                        log.details && 
                        (log.details.status === 'pending' || !log.details.status)
                    ).length;
                    document.getElementById('pendingRequests').textContent = pendingRequests;
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        function displayRecentActivity(logs) {
            const activityContainer = document.getElementById('recentActivity');
            
            if (logs.length === 0) {
                activityContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h5>No Recent Activity</h5>
                        <p>System activity will appear here</p>
                    </div>
                `;
                return;
            }

            activityContainer.innerHTML = logs.map(log => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge ${getActionBadge(log.action)} me-2">${formatAction(log.action)}</span>
                                <small class="text-muted">${new Date(log.timestamp).toLocaleString()}</small>
                            </div>
                            <div class="small text-muted">
                                ${formatLogDetails(log.details)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getActionBadge(action) {
            const badgeMap = {
                'client_signup': 'bg-success',
                'admin_add_question': 'bg-primary',
                'admin_update_question': 'bg-warning',
                'admin_delete_question': 'bg-danger',
                'subscription_created': 'bg-success',
                'create_question_request': 'bg-info',
                'update_question_request': 'bg-warning',
                'admin_process_question_request': 'bg-success',
                'revert_question_request': 'bg-danger'
            };
            return badgeMap[action] || 'bg-secondary';
        }

        function formatAction(action) {
            const actionMap = {
                'client_signup': 'Client Signup',
                'admin_add_question': 'Add Question',
                'admin_update_question': 'Update Question',
                'admin_delete_question': 'Delete Question',
                'subscription_created': 'Subscription',
                'create_question_request': 'New Request',
                'update_question_request': 'Update Request',
                'admin_process_question_request': 'Process Request',
                'revert_question_request': 'Revert Request'
            };
            return actionMap[action] || action.replace(/_/g, ' ');
        }

        function formatLogDetails(details) {
            if (!details) return 'No details available';
            
            try {
                if (typeof details === 'string') {
                    return details;
                }
                
                const entries = Object.entries(details);
                if (entries.length === 0) return 'No details available';
                
                return entries.map(([key, value]) => {
                    if (key === 'website' && value) {
                        return `Website: ${value}`;
                    }
                    if (key === 'client_name' && value) {
                        return `Client: ${value}`;
                    }
                    if (key === 'question_id' && value) {
                        return `Question ID: ${value.substring(0, 8)}...`;
                    }
                    if (key === 'request_type' && value) {
                        return `Type: ${value}`;
                    }
                    return `${key}: ${value}`;
                }).join(', ');
            } catch (error) {
                return 'Error parsing details';
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentTime').textContent = now.toLocaleDateString('en-US', options);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 1000;
                min-width: 300px;
            `;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }
        });
    </script>
</body>
</html>